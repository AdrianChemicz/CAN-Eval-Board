# CAN Evaluation Board

![Hardware on title](/Doc/HwOnTitle.png) <br />

CAN Evaluation Board is hardware project which provide evaluation board for CAN-FD. Evaluation board was prepared in two variant isolated and not isolated. Both variant use similar HW component like MCP2517FD and MCP2562FD chips. 

![Device overview](/Doc/BothDeviceImage.png) <br />

## 1.MCP2517FD

MCP2517FD is Microchip chip which work as SPI to CAN-FD converter. This chip provide also GPIO pins which can be configured via SPI and change state depending from situation like receive CAN message. Those GPIO pins was routed to connector CN1.<br /> 
On new design MCP2517FD chip is not recomended user should select MCP2518FD. Older driver should be compatible with this chip.

## 2.CAN transceiver

MCP2517FD chip to work with CAN network require CAN transceiver and for this purpose was chosen MCP2562FD chip in DIP8 package. Chip crisis cause that only this transceiver is available on market. This chip was optimaze for transfers up to 5 Mbps in CAN-FD mode.

## 3.Protection by isolation

Version of project which contain isolation to protect our system from high voltage on DB9 connector use DC/DC converter with galvanic separation to power CAN transceiver and optoisolation chip to separate CANTXD and CANRXD. As optoisolation was used MAX22245BAWA+ chip which add delay 43.7ns in worse case and allow to transmit signal with max transfer 25Mbps. Those parameters is very important because CAN controller during transmission via CANTX expect feeddback from transceiver on CANRX pin. Maximum delay between signal on pin CANTXD and CANRXD is equal 255ns. All things regarding optoisolation in CAN-FD systems was described in below document: <br />
[Meeting the Timing Requirements of CAN FD in Isolated CAN Systems for HEV/EVs](https://www.ti.com/lit/an/slla479/slla479.pdf) <br />

Delay on our system is also generated by PCB traces but this delay is very low (signal transmission speed is equal 6inch per ns). Equation about PCB signal delay is available on below page: <br />
[How to Calculate Trace Length from Time Delay Value for High-speed Signals](https://www.zuken.com/en/blog/how-to-calculate-trace-length-from-time-delay-value-for-high-speed-signals/) <br />

Worse case signal delay in our system was presented on below picture:
![Delay in our system](/Doc/DelayInOurSystem.png) <br />

In below table was presented typical and worse case signal propagation delay for all used electrical component.<br />
Electrical component | Typical propagation delay | Worse case propagation delay
------------ | ------------ | ------------
MAX22245BAWA+(Optoisolation chip) power from 3,3V | 23.4ns | 32.2ns
MAX22245BAWA+(Optoisolation chip) power from 5V | 22.6ns | 30.7ns
MCP2562FD(CAN transceiver) | 120ns | 180ns

Complete worse case propagation delay is equal:<br />
32.2ns + 30.7ns + 180ns = 242,9ns + small delay on traces which shouldn't exceed 1ns <br /><br />
In system was used two optoisolation chip instead one because selected chip transmit signal in one direction. Use bidirectional chip is very hard to find becauase chip crisis cause that many electrical component are unavailable on market. In project was used chip MAX22245BAWA+ which work only in single direction. Manufacturer Maxim Integrated offer similar chip but with bidirectional isolation this is marked as MAX22246BAWA+. Using this bidirectional chip PCB design will looks like better - one chip intead two.<br /><br />

To power chips on isolated part is used DC/DC converter with galvanic separation. In project was selected ![RFMM-0505S](https://recom-power.com/pdf/Econoline/RFMM.pdf) converter. This type of converter for correct operation require load on output so for this reason was used 470 ohm resistor(R3 on schematic).

## 4.Overal system design

On belew schematics was presented all parts of the system.

Version without optoisolation: <br />
![Device without opto](/Doc/NoOptoDesign.png) <br />
Version with optoisolation: <br />
![Device with opto](/Doc/OptoIsolationDesign.png) <br />

On below pin header which is the same for two type of board with MCP2517FD chip exist two type of voltage input 3.3V and 5V. 3.3V input is used to power MCP2517FD chip and optoisolation module. 5V connector is used to power CAN transceiver. MCP2517FD chip and optoisolation module can correctly operate with 5V power suplly(MCP2517FD can operate in voltage range from 2,7V to 5,5Vs and MAX22245BAWA+ can operate in voltage range from 1,71V to 5,5V) so it mean that two power suply isn't necessary and can be reduced to single 5V power suply connected to 3V3 and 5V connectors. Connect 5V to 3V3 connector on board with MCP2517FD was tested on setup with LPC11U24 microcontroller and communication working correctly(CAN traffic was send correctly to bus). Used LPC11U24 during test was powered from 3,3V and work correctly with MCP2517FD because used microcontroller pins are 5V tolerant so communication will not damage microcontroler. 
![Pin header](/Doc/PinsDescription.png) <br />

## 5.Project file

PCBs was designed in Kicad application and all files was added to appropriate project folders. In project folders also was added photos of PCB and PDF file with schematic. <br />
-board with optoisolation is available in below location: <br />
[CAN-FD optoisolated board](https://github.com/AdrianChemicz/CAN-Eval-Board/tree/main/CANFD_OptoIsolationBoardHardware) <br />
-board without optoisolation is available in below location: <br />
[CAN-FD board](https://github.com/AdrianChemicz/CAN-Eval-Board/tree/main/CANFD_BoardHardware) <br />

## 6.Software for MCP2517FD chip

### 6.1 Basic information
Microchip deliver example with library which can be very easly ported from microchip microcontroller to other microcontroller. From user perspective is only require to modify drv_spi.c file which contain access to SPI interface(only one file which depend from peripheral).

In drv_canfdspi_api.h header file we can find information "Subject to your compliance with these terms, you may use Microchip software and any derivatives exclusively with Microchip products." . According this paragraph I have doubt about legality usage of this library with MCP2517FD chip and NXP microcontrollers. Case was created on Microchip page and employee from Microchip answear that is only require use MCP2517xD chip with this driver and port to other microcontroller which belong to other manufacturer than microchip is legal.

Below I added links to microchip page with things for MCP2517FD chip: <br />
[-link to Microchip page with information about MCP2517FD](https://www.microchip.com/en-us/product/MCP2517FD) <br />
[-link to Microchip page with information about MCP2518FD which is recomended for new design](https://www.microchip.com/en-us/product/MCP2518FD) <br />
[-Link to source code example on Microchip page](https://ww1.microchip.com/downloads/en/DeviceDoc/MCP2517FD%20canfdspi%20API%20for%20SAMV71%20(v1.0).zip) <br /><br />
Complete port process of microchip library to other microcontroller require from user few steps and below all necessary things was described:<br />

1)From link section in this chapter please download SW example from mmicrochip page and copy "driver" directory from folder "MCP2517FD canfdspi API for SAMV71 (v1.0).zip\V71_CANFDSPI\V71_CANFDSPI" to new project directory.<br />
2)In \driver\spi\drv_spi.c modify below things:<br />
a)Modify function spi_master_init(void) which initialize microcontroller SPI port.<br />
a)modify function spi_master_transfer(...) which send data via microcontroller SPI port.<br />
c)modify #include section to keep only necessary things and include file with driver to used microcontroller.<br />
d)modify #define section to don't keep not used things.<br /><br />

In [SW directory](https://github.com/AdrianChemicz/CAN-Eval-Board/tree/main/SW)
 was provided examples for three LPC microcontrollers(MCP2517FD_ExampleFor_LPC111X, MCP2517FD_ExampleFor_LPC11UXX and MCP2517FD_ExampleFor_LPC82X). In those three examples most of code operate just on microchip API not on microntrollers peripherals. Provided code only use systick as timer which is common for all cortex-MX microcontrolers and can be very easy ported to other ARM microcontrollers. In those three provided example micirochip API is called from [MCP2517FD_ExampleFor_LPC111X.c](https://github.com/AdrianChemicz/CAN-Eval-Board/blob/main/SW/MCP2517FD_ExampleFor_LPC111X/src/MCP2517FD_ExampleFor_LPC111X.c), [MCP2517FD_ExampleFor_LPC11UXX.c](https://github.com/AdrianChemicz/CAN-Eval-Board/blob/main/SW/MCP2517FD_ExampleFor_LPC11UXX/src/MCP2517FD_ExampleFor_LPC11UXX.c) and [MCP2517FD_ExampleFor_LPC82X.c](https://github.com/AdrianChemicz/CAN-Eval-Board/blob/main/SW/MCP2517FD_ExampleFor_LPC82X/src/MCP2517FD_ExampleFor_LPC82X.c) files(single file per example). In provided examples is possible to prepare test of SPI interface without connected MPC2517FD chip. If physical connection with chip will be missing then SPI communication with chip will be not suspended by example. Using this feature in provided examples was added below code:
>#if 0 //SPI protocol debug code<br />
>	{<br />
>		uint8_t testedWritePayload[8] = {46, 5, 124, 119, 122, 9, 87, 234};<br />
>		uint8_t readPayload[8] = {0, 0, 0, 0, 0, 0, 0, 0};<br />
>		// Write data to RAM<br />
>		DRV_CANFDSPI_WriteByteArray(DRV_CANFDSPI_INDEX_0, cRAMADDR_START, testedWritePayload, 8);<br />
><br />
>		// Read data back from RAM<br />
>		DRV_CANFDSPI_ReadByteArray(DRV_CANFDSPI_INDEX_0, cRAMADDR_START, readPayload, 8);<br />
><br />
>		Nop();<br />
>	}<br />
>#endif<br />

Using this part of code user can verify that SPI work correctly by own SPI traffic with below log.<br /> 
Function DRV_CANFDSPI_WriteByteArray in debug code will cause that ganerated SPI traffic will be similar like this traffic below:
![SPI write](/Doc/LogicAnalyzerLog/SPI_WriteOperation.png)
Function DRV_CANFDSPI_ReadByteArray in debug code with correctly connected and configured MCP2517FD chip will cause that ganerated SPI traffic will be similar like this traffic below:
![SPI read](/Doc/LogicAnalyzerLog/SPI_ReadOperation.png)

Below was added SPI setting from Saleae logic analyzer used during decode data:
![SPI settings](/Doc/LogicAnalyzerLog/SPI_Settings.png)

In [directory with SPI screenshots](https://github.com/AdrianChemicz/CAN-Eval-Board/tree/main/Doc/LogicAnalyzerLog) was added log gather via Saleae logic analyzer in binary format and CSV file.

### 6.2 Code examples

In [SW directory](https://github.com/AdrianChemicz/CAN-Eval-Board/tree/main/SW) was provided few examples which can be directly imported to LPCXpresso. To setup complete working environment source code is not enough. To provide fully working environment is required microcontroller eval board connected to board with MCP2517FD so in this chapter was described connections between those two boards and other usefull information related to hardware.

#### 6.2.1 LPC82X example

In this example during test was used dedicated board which is available [here](https://github.com/AdrianChemicz/CAN-Eval-Board/tree/main/LPC82X_EvalBoard). LPC8X microcontroller family contain switch matrix which allow move peripheral functionality to one of available GPIO pins. This feature allow user to configure microcontroller pins in way which simplify connection with other hardware. LPC8X microcontroller board contain FT234XD chip which can be used to comunicate with PC using virtual COM port. <br />

Below was added picture how to connect two board:
![LPC82X Connection](/Doc/Connection/ConnectionSchematic_LPC824.png)
Pin connection table:
Connection name | MCP2517FD board | LPC82X board
------------ | ------------ | ------------
SSEL | CN1.8 nCS | CN5.12 PIO0_23/ADC_3/ACMP_I4
SCK | CN1.9 SCK | CN5.9 PIO0_12
MOSI | CN1.10 SDI | CN5.10 PIO0_13/ADC_10
MISO | CN1.7 SDO | CN5.11 PIO0_17/ADC_9
5V | CN1.2 5V | CN2 5V
3.3V | CN1.6 3V3 | CN3 3V3
GND | CN1.4 GND | CN4 GND

Photo with connected two board is available [here](/Doc/LPC82X_Connection.png).

#### 6.2.2 LPC11XX example

In this example during test was used board [OM11049](https://eu.mouser.com/ProductDetail/NXP-Semiconductors/OM11049598?qs=gr1fGwdOAsJfB09qfdGFmA%3D%3D). This board isn't available in sale - it was replaced by [OM13035](https://www.nxp.com/design/microcontrollers-developer-resources/lpcxpresso-board-for-lpc1115:OM13035). Main difference between OM11049 and OM13035 was changed microcontroller from LPC1114 to LPC1115. On OM13035 page PDF file with electrical schematic is the same like in OM11049 so it mean that microntroller pins location wasn't changed. Currently OM13035 also wasn't available in sale - was replaced by [OM13087](https://www.nxp.com/products/processors-and-microcontrollers/arm-microcontrollers/general-purpose-mcus/lpc1100-cortex-m0-plus-m0/lpcxpresso-board-for-lpc1115-with-cmsis-dap-probe:OM13087). Old and new board was compared and pins location on target side(LPC111X microcontroller side) between version wasn't changed. Only major differences between those two boards it is additional LED in new version of board(OM13087). OM11049 board don't provide 5V power source so to provide necessary voltage was used additional power source.<br />

Below was added picture how to connect two board:
![LPC111X Connection](/Doc/Connection/ConnectionSchematic_LPC1114.png)
Pin connection table:
Connection name | MCP2517FD board | OM11049 board
------------ | ------------ | ------------
SSEL | CN1.8 nCS | J6.7 PIO2_11/SCK0/CT32B0_CAP1
SCK | CN1.9 SCK | J6.23 PIO0_6/SCK0
MOSI | CN1.10 SDI | J6.5 PIO0_9/MOSI0/CT16B0_MAT1
MISO | CN1.7 SDO | J6.6 PIO0_8/MISO0/CT16B0_MAT0
5V | CN1.2 5V | ---
3.3V | CN1.6 3V3 | J6.28 3V3
GND | CN1.4 GND | J6.1 GND

Photo with connected two board is available [here](/Doc/LPC1114_Connection.png).

#### 6.2.3 LPC11UXX example

In this example during test was used dedicated board which is available [here](https://github.com/AdrianChemicz/FootController/tree/main/PCB). In this board used LPC11U24 microcontroller.<br />

Below was added picture how to connect two board:
![LPC11UXX Connection](/Doc/Connection/ConnectionSchematic_LPC11U24.png)
Pin connection table:
Connection name | MCP2517FD board | LPC11UXX board
------------ | ------------ | ------------
SSEL | CN1.8 nCS | CN5.5 PIO0_2/SSEL0/CT16B0_CAP0
SCK | CN1.9 SCK | CN7.1 PIO1_15/DCD/CT16B0_MAT2/SCK1
MOSI | CN1.10 SDI | CN5.1 PIO0_21/CT16B1_MAT0/MOSI1
MISO | CN1.7 SDO | CN7.8 PIO0_22/AD6/CT16B1_MAT1/MISO1
5V | CN1.2 5V | CN3 5V
3.3V | CN1.6 3V3 | CN4 3V3
GND | CN1.4 GND | CN2 GND

Photo with connected two board is available [here](/Doc/LPC11U24_Connection.png).

## 7.Other MCP2517FD chip hardware

In case when user would like to fast start prototype SW with real hardware then build own hardware isn't necessary. On market are provided solutions like this - [MCP2517FD click](https://www.mikroe.com/mcp2517fd-click). This board use product ID MIKROE-2379 and according this number can be found on [farnell](https://pl.farnell.com/mikroelektronika/mikroe-2379/can-fd-controller-click-board/dp/2858076?ost=mikroe-2379) or on [TME](https://www.tme.eu/pl/details/mikroe-2379/plytki-rozszerzajace/mikroelektronika/mcp2517fd-click/).




