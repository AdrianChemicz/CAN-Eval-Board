# CAN Evaluation Board

![Hardware on title](/Doc/HwOnTitle.png) <br />

CAN Evaluation Board is hardware project which provide evaluation board for CAN-FD. Evaluation board was prepared in two variant isolated and not isolated. Both variant use similar HW component like MCP2517FD and MCP2562FD chips. 

![Device overview](/Doc/BothDeviceImage.png) <br />

## 1.MCP2517FD

MCP2517FD is Microchip chip which work as SPI to CAN-FD converter. This chip provide also GPIO pins which can be configured via SPI and change state depending from situation like receive CAN message. Those GPIO pins was routed to connector CN1.<br /> 
On new design MCP2517FD chip is not recomended user should select MCP2518FD. Older driver should be compatible with this chip.

## 2.Can transceiver

MCP2517FD chip to work with CAN network require CAN transceiver and for this purpose was chosen MCP2562FD chip in DIP8 package. Chip crisis cause that only this transceiver is available on market. This chip was optimaze for transfers up to 5 Mbps in CAN-FD mode.

## 3.Protection by isolation

Version of project which contain isolation to protect our system from high voltage on DB9 connector use DC/DC converter with galvanic separation to power CAN transceiver and optoisolation chip to separate CANTXD and CANRXD. As optoisolation was used MAX22245BAWA+ chip which add delay 43.7ns in worse case and allow to transmit signal with max transfer 25Mbps. Those parameters is very important because CAN controller during transmission via CANTX expect feeddback from transceiver on CANRX pin. Maximum delay between signal on pin CANTXD and CANRXD is equal 255ns. All things regarding optoisolation in CAN-FD systems was described in below document: <br />
[Meeting the Timing Requirements of CAN FD in Isolated CAN Systems for HEV/EVs](https://www.ti.com/lit/an/slla479/slla479.pdf) <br />

Delay on our system is also generated by PCB traces but this delay is very low (signal transmission speed is equal 6inch per ns). Equation about PCB signal delay is available on below page: <br />
[How to Calculate Trace Length from Time Delay Value for High-speed Signals](https://www.zuken.com/en/blog/how-to-calculate-trace-length-from-time-delay-value-for-high-speed-signals/) <br />

Worse case signal delay in our system was presented on below picture:
![Delay in our system](/Doc/DelayInOurSystem.png) <br />

In below table was presented typical and worse case signal propagation delay for all used electrical component.<br />
Electrical component | Typical propagation delay | Worse case propagation delay
------------ | ------------ | ------------
MAX22245BAWA+ power from 3,3V | 23.4ns | 32.2ns
MAX22245BAWA+ power from 5V | 22.6ns | 30.7ns
MCP2562FD | 120ns | 180ns

Complete worse case propagation delay is equal:
32.2ns + 30.7ns + 180ns = 242,9ns + small delay on traces which shouldn't exceed 1ns
In system was used two optoisolation chip instead one because selected chip transmit signal in one direction. Use bidirectional chip is very hard to find becauase chip crisis cause that many electrical component are unavailable on market. In project was used chip MAX22245BAWA+ which work only in single direction. Manufacturer Maxim Integrated offer similar chip but with bidirectional isolation this is marked as MAX22246BAWA+. Using this bidirectional chip PCB design will looks like better - one chip intead two.

## 4.Overal system design

On belew schematics was presented all parts of the system.

Version without optoisolation: <br />
![Device without opto](/Doc/NoOptoDesign.png) <br />
Version with optoisolation: <br />
![Device with opto](/Doc/OptoIsolationDesign.png) <br />

## 5.Project file

PCBs was designed in Kicad application and all files was added to appropriate project folders. In project folders also was added photos of PCB and PDF file with schematic. <br />
-board with optoisolation is available in below location: <br />
[CAN-FD optoisolated board](https://github.com/AdrianChemicz/CAN-Eval-Board/tree/main/CANFD_OptoIsolationBoardHardware) <br />
-board without optoisolation is available in below location: <br />
[CAN-FD board](https://github.com/AdrianChemicz/CAN-Eval-Board/tree/main/CANFD_BoardHardware) <br />

## 6.Software for MCP2517FD chip

### 6.1 Basic information
Microchip deliver example with library which can be very easly ported from microchip microcontroller to other microcontroller. From user perspective is only require to modify drv_spi.c file which contain access to SPI interface(only one file which depend from peripheral).

In drv_canfdspi_api.h header file we can find information "Subject to your compliance with these terms, you may use Microchip software and any derivatives exclusively with Microchip products." . According this paragraph I have doubt about legality usage of this library with MCP2517FD chip and NXP microcontrollers. Case was created on Microchip page and employee from Microchip answear that is only require use MCP2517xD chip with this driver and port to other microcontroller is legal.

Below I added links to microchip page with things for MCP2517FD chip: <br />
[-link to Microchip page with information about MCP2517FD](https://www.microchip.com/en-us/product/MCP2517FD) <br />
[-link to Microchip page with information about MCP2518FD which is recomended for new design](https://www.microchip.com/en-us/product/MCP2518FD) <br />
[-Link to source code example on Microchip page](https://ww1.microchip.com/downloads/en/DeviceDoc/MCP2517FD%20canfdspi%20API%20for%20SAMV71%20(v1.0).zip) <br />

### 6.2 Code example


### 6.3 Instruction step by step how port example
